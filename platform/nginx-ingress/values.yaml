# NGINX Ingress Controller Helm Chart Values
# Chart: ingress-nginx/ingress-nginx v4.14.3
# Controller App Version: v1.14.3

controller:
  # --- Replica Configuration ---
  replicaCount: 1  # Homelab; scale to 2+ for HA

  # --- Service Configuration ---
  service:
    type: LoadBalancer
    annotations:
      # Azure-specific annotations for LoadBalancer health probes
      service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz
    # Preserve source IP for rate limiting and access logging
    externalTrafficPolicy: Local

  # --- Resource Limits ---
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # --- Security Context ---
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101  # NGINX Ingress default user
    fsGroup: 101
    seccompProfile:
      type: RuntimeDefault

  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false  # NGINX requires writable /tmp for client body buffering
    runAsNonRoot: true
    runAsUser: 101
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE  # Required for binding to ports 80/443

  # --- Prometheus Metrics ---
  metrics:
    enabled: true
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "10254"
    serviceMonitor:
      enabled: true
      additionalLabels:
        prometheus: monitoring  # Matches kube-prometheus-stack serviceMonitorSelector

  # --- NGINX Configuration ---
  config:
    # TLS configuration (ready for cert-manager in task #93)
    ssl-protocols: "TLSv1.2 TLSv1.3"
    ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
    ssl-prefer-server-ciphers: "true"

    # Client request configuration
    proxy-body-size: "50m"  # Platform API may accept scaffold template uploads
    proxy-buffer-size: "8k"
    proxy-read-timeout: "60"
    proxy-send-timeout: "60"

    # Connection limits (homelab-sized)
    limit-connections: "100"
    limit-rps: "20"

    # Proxy headers for correct client IP and protocol forwarding
    use-forwarded-headers: "true"
    compute-full-forwarded-for: "true"
    use-proxy-protocol: "false"

    # Logging
    log-format-escape-json: "true"
    log-format-upstream: '{"time": "$time_iso8601", "remote_addr": "$remote_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for", "request_id": "$req_id", "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time, "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args", "request_length": $request_length, "duration": $request_time, "method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": "$http_user_agent", "upstream_addr": "$upstream_addr", "upstream_status": "$upstream_status", "upstream_response_time": "$upstream_response_time", "upstream_response_length": "$upstream_response_length"}'

  # --- Admission Webhooks ---
  admissionWebhooks:
    enabled: true
    patch:
      enabled: true
      image:
        pullPolicy: IfNotPresent
      # Disable TTL so Argo CD can track Job completion properly
      # (Jobs with TTL get cleaned up before Argo CD sees completion)
      ttlSecondsAfterFinished: null

# --- Default Backend Configuration ---
defaultBackend:
  enabled: true
  image:
    pullPolicy: IfNotPresent
  replicaCount: 1
  resources:
    requests:
      cpu: 10m
      memory: 20Mi
    limits:
      cpu: 20m
      memory: 40Mi
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534  # nobody user
    seccompProfile:
      type: RuntimeDefault
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65534
    capabilities:
      drop:
        - ALL

# --- RBAC Configuration ---
rbac:
  create: true
  scope: false  # Cluster-wide access to Ingress/Service/Endpoint resources

# --- Service Account ---
serviceAccount:
  create: true
  automount: true
