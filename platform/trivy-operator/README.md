# Trivy Operator

Continuous CVE vulnerability scanning for workload container images.

## What It Does

Trivy Operator watches all workloads cluster-wide and automatically scans their container images for:

- **CVE vulnerabilities** — OS packages, language dependencies, app libraries
- **Misconfigurations** — K8s manifest security best practices (overlaps with Gatekeeper, different perspective)
- **Exposed secrets** — hardcoded passwords, API keys, tokens accidentally baked into images
- **RBAC issues** — overly permissive ClusterRoles/Roles

Results are persisted as K8s custom resources that the Platform API aggregates.

## Architecture

```text
┌─────────────────────────────────────────────────────────────────┐
│ Trivy Operator (trivy-system namespace)                        │
│                                                                 │
│  ┌──────────────┐         Watches workloads cluster-wide       │
│  │  Operator    │────────────────────────────────────────┐     │
│  │  Controller  │                                        │     │
│  └──────────────┘                                        │     │
│         │                                                │     │
│         │ Creates scan Jobs on schedule + workload CRUD │     │
│         ▼                                                ▼     │
│  ┌──────────────┐                                 ┌──────────┐│
│  │ Scan Job Pod │                                 │ Workload ││
│  │ (trivy CLI)  │─────pulls image────────────────▶│  Image   ││
│  └──────────────┘                                 └──────────┘│
│         │                                                      │
│         │ Creates VulnerabilityReport CRD                     │
│         ▼                                                      │
│  ┌──────────────────────────────┐                             │
│  │ VulnerabilityReport          │                             │
│  │ - image: app:v1.2.3          │                             │
│  │ - vulnerabilities:           │                             │
│  │   - CVE-2024-1234 (Critical) │                             │
│  │   - CVE-2024-5678 (High)     │                             │
│  └──────────────────────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
                    │
                    │ Platform API watches VulnerabilityReports
                    ▼
         ┌─────────────────────────┐
         │ GET /api/v1/compliance/ │
         │ - /vulns                │  ◀──── rdp CLI / Portal UI
         │ - /vulns/:namespace     │
         │ - /vulns/:image         │
         └─────────────────────────┘
```

## CRDs Created

| CRD | Purpose | Generated By |
| --- | --- | --- |
| `VulnerabilityReport` | CVE scan results per workload | Trivy scanner (primary use case) |
| `ConfigAuditReport` | K8s manifest security best practices | Trivy config scanner |
| `ExposedSecretReport` | Hardcoded secrets in images | Trivy secret scanner |
| `RbacAssessmentReport` | RBAC privilege analysis | Trivy RBAC scanner |
| `ClusterComplianceReport` | CIS/NSA framework mapping | Compliance controller (disabled by default) |

## Scanning Strategy

**Event-driven + scheduled:**

1. **On workload creation/update** — Operator detects new Deployment/StatefulSet/DaemonSet → creates scan Job immediately
2. **Daily cron scan** — Re-scan all workloads at 2 AM (configurable via `scanJob.scanJobsConcurrentLimit`)
3. **Database updates** — Trivy downloads the latest CVE database from GitHub Container Registry before each scan

**Why both?** New workloads get scanned immediately (fast feedback), but CVE databases are updated daily — scheduled scans catch newly-disclosed vulnerabilities in images that were previously clean.

## Integration Points

### Platform API

The `/api/v1/compliance/*` endpoints aggregate VulnerabilityReports via client-go watches:

```bash
# List all vulnerabilities across the platform
GET /api/v1/compliance/vulns

# Filter by namespace
GET /api/v1/compliance/vulns?namespace=my-app

# Filter by severity
GET /api/v1/compliance/vulns?severity=CRITICAL,HIGH

# Get vulnerability details for a specific image
GET /api/v1/compliance/vulns/my-app:v1.2.3
```

Response includes: CVE ID, severity, CVSS score, affected package, fixed version, image reference.

### Portal UI

**Vulnerability Feed panel** (task #83) — Real-time feed of Critical/High CVEs grouped by image. Click to see remediation guidance (upgrade to fixed version).

**Compliance Score donut chart** (task #81) — Aggregates Gatekeeper violations + Trivy CVE counts into a single compliance percentage.

### rdp CLI

```bash
# Summary view
rdp compliance summary

# Vulnerability-specific commands
rdp compliance vulns --severity CRITICAL
rdp compliance vulns --namespace my-app
rdp compliance vulns --image my-app:v1.2.3
```

## Comparison: Trivy vs Gatekeeper

Both are compliance tools, but they operate at different lifecycle stages:

| Aspect | Gatekeeper (OPA) | Trivy Operator |
| --- | --- | --- |
| **When** | Admission time (pre-deployment) | Post-deployment (continuous) |
| **What** | K8s manifest policy | Container image CVE scanning |
| **Action** | DENY bad manifests before creation | REPORT vulnerabilities in running workloads |
| **Blocking** | Yes (admission webhook) | No (discovery only) |
| **Example** | Block `:latest` tag, enforce resource limits | Discover CVE-2024-1234 in nginx:1.19 |

**Complementary, not overlapping.** Gatekeeper prevents misconfigured workloads from entering the cluster. Trivy discovers security issues in the images that Gatekeeper allowed in.

## Resource Usage

**Operator pod:** ~100 MB memory, minimal CPU (just watches K8s events)

**Scan job pods:** ~256-512 MB memory per concurrent scan, CPU burst during scan (1-2 minutes per image)

**Concurrency limit:** `scanJobsConcurrentLimit: 3` — limits simultaneous scans to avoid resource exhaustion on homelab hardware.

## Configuration

### Exclude Namespaces

Platform namespaces are excluded by default (see `values.yaml: excludeNamespaces`). This prevents scanning platform tooling like Argo CD, Crossplane, Gatekeeper, etc.

To exclude additional namespaces (e.g., a dev sandbox):

```yaml
# values.yaml
excludeNamespaces: "kube-system,kube-node-lease,kube-public,argocd,crossplane-system,gatekeeper-system,trivy-system,external-secrets,monitoring,dev-sandbox"
```

Commit → push → Argo CD syncs → Trivy stops scanning the excluded namespace.

### Scan Schedule

Default: daily at 2 AM (via cron). To change:

```yaml
# values.yaml (add custom cron annotation to scan jobs)
# Note: Trivy Operator 0.27.x doesn't directly expose cron schedule in values.yaml.
# Scans are triggered on workload CRUD events + a background reconcile loop.
# For explicit cron control, consider ClientServer mode with scheduled scan CronJobs.
```

For more control, switch to **ClientServer mode** (central trivy-server) and create a CronJob that triggers scans via the Trivy Operator API.

### Image Registry Authentication

If scanning images from private ACR:

1. Create a K8s Secret with ACR credentials in each namespace:
   ```bash
   kubectl create secret docker-registry acr-creds \
     --docker-server=<ACR_LOGIN_SERVER> \
     --docker-username=<SP_APP_ID> \
     --docker-password=<SP_PASSWORD> \
     --namespace=<TARGET_NAMESPACE>
   ```

2. Reference the secret in Deployment `imagePullSecrets` — Trivy Operator will use the same credentials.

Alternatively, use **Azure Workload Identity** with AKS's built-in ACR integration (no secrets needed) — Trivy inherits the node's managed identity for ACR pulls.

## Troubleshooting

### No VulnerabilityReports Generated

**Check operator logs:**
```bash
kubectl logs -n trivy-system deployment/trivy-operator -f
```

**Common causes:**
- Operator can't pull images (check `imagePullSecrets`)
- Scan job timeout too short (increase `scanJobTimeout` in values.yaml)
- Excluded namespace (check `excludeNamespaces`)

### Scan Jobs Stuck in Pending

**Check resource quotas:**
```bash
kubectl describe pod -n trivy-system -l app.kubernetes.io/name=trivy-operator
```

**Common causes:**
- Node resource exhaustion (reduce `scanJobsConcurrentLimit`)
- Image pull errors (check ACR access)

### Outdated CVE Database

Trivy downloads the DB before each scan. If scans fail with "database not found":

```bash
# Manually trigger DB update (restart operator)
kubectl rollout restart deployment/trivy-operator -n trivy-system
```

The operator will re-download the DB on startup.

## Metrics & Monitoring

Trivy Operator exposes Prometheus metrics at `:8080/metrics`. After task #35 (kube-prometheus-stack), enable ServiceMonitor:

```yaml
# values.yaml
serviceMonitor:
  enabled: true
  labels:
    release: prometheus
```

**Key metrics:**
- `trivy_vulnerability_id` — CVE count by severity
- `trivy_image_vulnerabilities` — vulnerabilities per image
- `trivy_scan_duration_seconds` — scan performance

## Upgrade Path

Current: `0.32.0` (latest as of February 2026)

To upgrade:
1. Update `targetRevision` in `application.yaml`
2. Review [Trivy Operator release notes](https://github.com/aquasecurity/trivy-operator/releases)
3. Commit → push → Argo CD syncs → operator upgrades

**Breaking changes:** CRD schema changes may require deleting old VulnerabilityReports. The operator will regenerate them on next scan.

## References

- [Trivy Operator Docs](https://aquasecurity.github.io/trivy-operator/)
- [Trivy CVE Database](https://github.com/aquasecurity/trivy-db)
- [Helm Chart](https://github.com/aquasecurity/trivy-operator/tree/main/deploy/helm)
