# Argo CD Token Setup for Platform API

## Problem Statement

Task #89: The Platform API's `/api/v1/apps` endpoints require an Argo CD API token to interact with Argo CD's API. This token must be:

1. Generated via Argo CD CLI after the service account is created
2. Stored in the bootstrap Azure Key Vault
3. Synced to the Platform API pod via External Secrets Operator

## GitOps vs. Imperative Split

**GitOps-managed (declarative, in Git):**

- ✅ Argo CD service account definition (`platform/argocd/values.yaml`)
- ✅ RBAC policies for the service account (`platform/argocd/values.yaml`)
- ✅ ExternalSecret resource (`platform/platform-api/externalsecrets/platform-api-secrets.yaml`)
- ✅ ConfigMap with Argo CD server URL (`platform/platform-api/configmap.yaml`)

**Imperative bootstrap (one-time script):**

- ⚠️ Token generation (requires Argo CD API call)
- ⚠️ Key Vault secret creation (token value never in Git)

## Current Status

✅ ExternalSecret configured correctly
✅ Deployment references the secret via `envFrom`
✅ ConfigMap has correct Argo CD server URL (`http://argocd-server.argocd.svc.cluster.local`)
✅ Argo CD service account defined in `values.yaml`
✅ RBAC policies defined in `values.yaml`
⚠️ Token not yet generated (run `setup-argocd-token.sh`)

## Solution Steps

### Step 1: GitOps Configuration (Already Complete)

The Argo CD service account and RBAC are **managed via Helm values** in `platform/argocd/values.yaml`:

```yaml
configs:
  cm:
    accounts.platform-api: apiKey

  rbac:
    policy.csv: |
      # Platform API role — application management
      p, role:platform-api, applications, *, */*, allow
      p, role:platform-api, applicationsets, *, */*, allow
      p, role:platform-api, projects, get, *, allow
      g, platform-api, role:platform-api
```

When Argo CD syncs from Git, these settings are applied automatically. **No manual kubectl patches required.**

### Step 2: Generate and Store Token (One-Time Bootstrap)

The token is a JWT generated by Argo CD's API, not stored in Git. Use the provided script:

```bash
cd platform/platform-api

# Option 1: Auto-detect Key Vault name from Terraform (if using local state)
./setup-argocd-token.sh

# Option 2: Specify Key Vault name explicitly (recommended for TFC)
./setup-argocd-token.sh --kv-name <your-keyvault-name>
```

**What the script does:**

1. ✅ Verifies Argo CD service account exists (from GitOps)
2. ✅ Generates API token via `argocd account generate-token`
3. ✅ Stores token in Azure Key Vault as `argocd-token`
4. ✅ Triggers ExternalSecret sync (if Platform API is deployed)

**What the script does NOT do:**

- ❌ Patch ConfigMaps (service account + RBAC are in values.yaml)
- ❌ Restart Argo CD server (Helm manages the Deployment)

### Step 3: Verify GitOps Sync (Optional)

```bash
# Check that the service account and RBAC were applied
kubectl get configmap argocd-cm -n argocd -o yaml | grep "accounts.platform-api"
kubectl get configmap argocd-rbac-cm -n argocd -o yaml | grep "role:platform-api"
```

### Step 4: Verify ExternalSecret Sync

```bash
# Check if ExternalSecret is syncing correctly
kubectl get externalsecret platform-api-secrets -n platform

# Expected output:
# NAME                     STORE                 REFRESH INTERVAL   STATUS        READY
# platform-api-secrets     azure-bootstrap-kv    1h                 SecretSynced  True

# If status is not SecretSynced, check the conditions:
kubectl describe externalsecret platform-api-secrets -n platform

# Verify the Kubernetes Secret was created with all three keys
kubectl get secret platform-api-secrets -n platform -o jsonpath='{.data}' | jq 'keys'

# Expected output: ["ARGOCD_TOKEN", "GITHUB_TOKEN", "OPENAI_API_KEY"]
```

### Step 5: Test Argo CD Integration

```bash
# Port-forward to Platform API
kubectl port-forward svc/platform-api -n platform 8080:8080

# Test the /api/v1/apps endpoint
curl -H "Authorization: Bearer test-token" \
  http://localhost:8080/api/v1/apps | jq

# Expected: JSON array of Argo CD applications
```

## Verification Checklist

**GitOps-managed (check Git and Argo CD):**

- [ ] `platform/argocd/values.yaml` has `accounts.platform-api: apiKey`
- [ ] `platform/argocd/values.yaml` has RBAC policy for `platform-api` role
- [ ] `platform/platform-api/configmap.yaml` has correct `ARGOCD_SERVER_URL`
- [ ] Argo CD Application synced successfully

**Imperative bootstrap (check script output):**

- [ ] `setup-argocd-token.sh` ran successfully
- [ ] Token stored in Azure Key Vault as `argocd-token`
- [ ] ExternalSecret status shows `SecretSynced: True`
- [ ] Kubernetes Secret `platform-api-secrets` exists with `ARGOCD_TOKEN` key

**Integration test:**

- [ ] `/api/v1/apps` endpoint returns valid JSON (no 401 errors)

## Troubleshooting

### ExternalSecret stuck in SecretSyncedError

**Symptom:** `kubectl describe externalsecret platform-api-secrets -n platform` shows `SecretSyncedError`

**Solution:**

```bash
# Check if the secret exists in Key Vault
az keyvault secret list --vault-name "$KV_NAME" -o table | grep argocd-token

# If missing, go back to Step 4
# If present, check ESO logs
kubectl logs -n external-secrets -l app.kubernetes.io/name=external-secrets
```

### Platform API returns 401 Unauthorized from Argo CD

**Symptom:** Platform API logs show "request failed: 401"

**Possible causes:**

1. Token not yet synced to pod - wait for ExternalSecret refresh or force sync
2. Token expired - regenerate token and update Key Vault
3. RBAC policy incorrect - verify policy.csv in argocd-rbac-cm

**Solution:**

```bash
# Force ExternalSecret sync
kubectl annotate externalsecret platform-api-secrets -n platform \
  force-sync="$(date +%s)" --overwrite

# Restart Platform API
kubectl rollout restart deployment platform-api -n platform
```

### Argo CD server connection refused

**Symptom:** Platform API logs show "connection refused"

**Solution:** Verify the ConfigMap has the correct server URL:

```bash
kubectl get configmap platform-api-config -n platform -o yaml | grep ARGOCD_SERVER_URL

# Should be: http://argocd-server.argocd.svc.cluster.local
```

## Security Considerations

- **Token Rotation:** Argo CD tokens expire by default after 90 days. Set a calendar reminder to regenerate.
- **Least Privilege:** The current RBAC grants full access to applications. In production, scope down to specific projects.
- **Token Storage:** The token is stored in Azure Key Vault with RBAC access control. Only ESO's managed identity can read it.
- **No Static Secrets:** The token never appears in Git or Kubernetes manifests.

## Automation (Future Enhancement)

Consider creating a Terraform module or Helm hook to automate:

1. Argo CD service account creation via ConfigMap patches
2. Token generation via Argo CD API (not CLI)
3. Key Vault secret provisioning

This would eliminate manual steps 2-4.

## References

- [Argo CD RBAC Documentation](https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/)
- [Argo CD Accounts Documentation](https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/)
- [External Secrets Operator](https://external-secrets.io/)
