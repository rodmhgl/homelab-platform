## Crossplane Config — Argo CD Application
##
## Applies ProviderConfig, XRDs, and Compositions AFTER the Provider pods are running
## and have registered their CRDs (wave 3 > wave 2).
##
## The CRDs applied here (azure.upbound.io/v1beta1/ProviderConfig,
## apiextensions.crossplane.io/v1/CompositeResourceDefinition, etc.) are installed
## by the Provider pods themselves — not by Crossplane core. Provider pods pull their
## package, register CRDs, and only then are the resource types available.
##
## SkipDryRunOnMissingResource=true: if Argo CD attempts a sync before provider CRDs
## are fully registered, it skips the server-side dry-run instead of failing. Combined
## with automated selfHeal, Argo CD will keep retrying until all CRDs exist and
## every resource reaches Synced+Healthy.
##
## Sync ordering within this Application:
##   Wave 2: config/provider-config.yaml     (ProviderConfig — needs provider CRDs)
##   Wave 3: xrds/x*.yaml                    (XRDs — needs ProviderConfig)
##   Wave 4: compositions/*.yaml             (Compositions — needs XRDs)
##
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "3"
  labels:
    app.kubernetes.io/managed-by: argocd
    app.kubernetes.io/name: crossplane-config
    app.kubernetes.io/part-of: platform
  name: crossplane-config
  namespace: argocd
spec:
  destination:
    namespace: crossplane-system
    server: https://kubernetes.default.svc
  project: platform
  source:
    repoURL: https://github.com/rodmhgl/homelab-platform
    targetRevision: main
    path: platform/crossplane-config
    directory:
      recurse: true
      exclude: "application.yaml"
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
      ## Skip server-side dry-run for resources whose CRDs may not be registered
      ## yet when this Application first attempts to sync. selfHeal retries until
      ## provider CRDs are available and all resources reach Synced+Healthy.
      - SkipDryRunOnMissingResource=true
