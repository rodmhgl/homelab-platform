## Falco Helm values for homelab IDP
## Chart: falcosecurity/falco
## Version: 8.0.x
##
## Falco installs as a DaemonSet (one pod per node) and monitors syscalls via eBPF or
## kernel module to detect suspicious runtime behavior.
##
## Driver modes:
## - modern_ebpf: Modern eBPF probe with CO-RE (Compile Once, Run Everywhere)
## - ebpf: Traditional eBPF probe
## - kmod: Kernel module (requires kernel headers)
## - auto: Auto-detect best driver
##
## For AKS with Ubuntu nodes (Kernel >= 5.15), modern_ebpf is the best choice.

## Driver configuration
driver:
  ## Enable driver (required for syscall monitoring)
  enabled: true

  ## Driver kind: modern_ebpf is preferred for AKS Ubuntu nodes
  kind: modern_ebpf

  ## kmod configuration (not used with modern_ebpf, but included for completeness)
  kmod:
    bufSizePreset: 4
    dropFailedExit: false

## Falco configuration
## Note: In v8.0.0, many of these settings moved to falco.yaml config file
## The chart manages the config file generation automatically
falco:
  ## Watch config files for changes (hot reload)
  watch_config_files: true

  ## JSON output for easier parsing by Falcosidekick
  json_output: true
  json_include_output_property: true
  json_include_tags_property: true

  ## Log level (emergency, alert, critical, error, warning, notice, info, debug)
  log_level: info

  ## Priority threshold for alerts (debug, info, notice, warning, error, critical, alert, emergency)
  ## We only want to be notified about warnings and above
  priority: warning

  ## Syscall event drops — if Falco can't keep up with syscall rate, it drops events
  syscall_event_drops:
    threshold: 0.01
    actions:
      - log
      - alert

  ## Buffered outputs (improves performance by batching events)
  buffered_outputs: true

  ## HTTP output disabled (we use Falcosidekick instead for routing)
  http_output:
    enabled: false

  ## Program output disabled (we use Falcosidekick for webhook delivery)
  program_output:
    enabled: false

  ## gRPC server (deprecated - will be configured later for Falcosidekick)
  ## For now, disabled to avoid TLS certificate errors
  ## Falcosidekick (Task #34) will use the unix socket or http_output instead
  grpc:
    enabled: false

  ## gRPC output (deprecated - disabled for now)
  grpc_output:
    enabled: false

## Resource limits for Falco pods
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 200m
    memory: 256Mi

## Tolerations — run on all nodes (including control plane if tainted)
tolerations:
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane

## Service account
serviceAccount:
  create: true
  name: falco

## Security context
## Note: In v8.0.0, security context is auto-configured based on driver.kind
## For modern_ebpf, the chart automatically sets privileged: true
## We rely on the chart's automatic configuration
podSecurityContext: {}

## Container security context
## Auto-configured by the chart based on driver.kind
## For modern_ebpf: privileged: true is set automatically
containerSecurityContext: {}

## Custom rules — loaded via customRules
## In v8.0.0, custom rules are defined inline and mounted automatically by the chart
## The chart creates a ConfigMap and mounts it into /etc/falco/rules.d/
## We'll load our custom rules from the separate ConfigMap created by Argo CD
customRules: {}
  # We use a separate ConfigMap (falco-custom-rules) managed by Argo CD
  # and mount it via extraVolumes/extraVolumeMounts below

## Extra volumes for custom rules
## Mount the ConfigMap created by Argo CD from custom-rules.yaml
extraVolumes:
  - name: custom-rules
    configMap:
      name: falco-custom-rules

extraVolumeMounts:
  - name: custom-rules
    mountPath: /etc/falco/rules.d
    readOnly: true

## Falcosidekick integration
## Falcosidekick is deployed separately (task #34) and receives events from Falco
## via gRPC, then routes them to multiple destinations (Platform API webhook, Slack, etc.)
falcosidekick:
  ## Falcosidekick is installed separately (not as a subchart)
  ## This keeps the installation modular: Falco (wave 8), Falcosidekick (wave 9)
  enabled: false

## RBAC — Falco needs cluster-wide read access to pods/namespaces for enrichment
rbac:
  create: true

## Service Monitor for Prometheus (kube-prometheus-stack)
## Falco exposes metrics on /metrics (events processed, drops, rule matches, etc.)
serviceMonitor:
  enabled: false  # Set to true after kube-prometheus-stack is fully deployed
  labels:
    release: prometheus
  interval: 30s
  scrapeTimeout: 10s

## Node affinity/tolerations — not needed for homelab single node pool
nodeSelector: {}
affinity: {}
