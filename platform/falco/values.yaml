## Falco Helm values for homelab IDP
## Chart: falcosecurity/falco
## Version: 8.0.x
##
## Falco installs as a DaemonSet (one pod per node) and monitors syscalls via eBPF or
## kernel module to detect suspicious runtime behavior.
##
## Driver modes:
## - modern_ebpf: Modern eBPF probe with CO-RE (Compile Once, Run Everywhere)
## - ebpf: Traditional eBPF probe
## - kmod: Kernel module (requires kernel headers)
## - auto: Auto-detect best driver
##
## For AKS with Ubuntu nodes (Kernel >= 5.15), modern_ebpf is the best choice.

## Driver configuration
driver:
  ## Enable driver (required for syscall monitoring)
  enabled: true

  ## Driver kind: modern_ebpf is preferred for AKS Ubuntu nodes
  kind: modern_ebpf

  ## kmod configuration (not used with modern_ebpf, but included for completeness)
  kmod:
    bufSizePreset: 4
    dropFailedExit: false

## Falco configuration
## Note: In v8.0.0, many of these settings moved to falco.yaml config file
## The chart manages the config file generation automatically
falco:
  ## Watch config files for changes (hot reload)
  watch_config_files: true

  ## JSON output for easier parsing by Falcosidekick
  json_output: true
  json_include_output_property: true
  json_include_tags_property: true

  ## Log level (emergency, alert, critical, error, warning, notice, info, debug)
  log_level: info

  ## Priority threshold for alerts (debug, info, notice, warning, error, critical, alert, emergency)
  ## We only want to be notified about warnings and above
  priority: warning

  ## Syscall event drops — if Falco can't keep up with syscall rate, it drops events
  syscall_event_drops:
    threshold: 0.01
    actions:
      - log
      - alert

  ## Buffered outputs (improves performance by batching events)
  buffered_outputs: true

  ## HTTP output disabled (we use Falcosidekick instead for routing)
  http_output:
    enabled: false

  ## Program output disabled (we use Falcosidekick for webhook delivery)
  program_output:
    enabled: false

  ## gRPC server (deprecated - will be configured later for Falcosidekick)
  ## For now, disabled to avoid TLS certificate errors
  ## Falcosidekick (Task #34) will use the unix socket or http_output instead
  grpc:
    enabled: false

  ## gRPC output (deprecated - disabled for now)
  grpc_output:
    enabled: false

## Resource limits for Falco pods
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 200m
    memory: 256Mi

## Tolerations — run on all nodes (including control plane if tainted)
tolerations:
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane

## Service account
serviceAccount:
  create: true
  name: falco

## Security context
## Note: In v8.0.0, security context is auto-configured based on driver.kind
## For modern_ebpf, the chart automatically sets privileged: true
## We rely on the chart's automatic configuration
podSecurityContext: {}

## Container security context
## Auto-configured by the chart based on driver.kind
## For modern_ebpf: privileged: true is set automatically
containerSecurityContext: {}

## Custom rules — loaded via customRules
## In v8.0.0, custom rules are defined inline and the chart automatically
## creates a ConfigMap and mounts it into /etc/falco/rules.d/
##
## IMPORTANT: We define rules inline here (not via separate ConfigMap)
## because the Helm chart v8.0.0 doesn't support extraVolumes/extraVolumeMounts
customRules:
  rules-homelab.yaml: |-
    ##############################################################################
    ## Custom Macros and Lists (Homelab-specific)
    ##############################################################################
    ## IMPORTANT: Do NOT redefine macros/lists that exist in Falco's default rules!
    ## Redefinitions break default rules. Only define NEW macros with homelab_ prefix.

    ## Macro: Monitor all namespaces except kube-system (start noisy, tune later)
    - macro: homelab_monitored_namespace
      condition: (k8s.ns.name != "kube-system")

    ## Macro: Shell processes using Falco's default shell_binaries list
    - macro: homelab_shell_procs
      condition: (proc.name in (shell_binaries))

    ## Macro: Sensitive file read using Falco's default sensitive_files macro
    - macro: homelab_sensitive_file_read
      condition: (sensitive_files and evt.is_open_read=true)

    ##############################################################################
    ## Rule 1: Unexpected Shell in Container
    ##############################################################################
    - rule: Unexpected Shell Spawned in Container
      desc: >
        A shell was spawned inside a production container. This may indicate
        an attacker gaining interactive access, kubectl exec abuse, or a
        misconfigured application health check. Investigate the process tree
        and parent command to determine legitimacy.
      condition: >
        spawned_process and
        container and
        homelab_monitored_namespace and
        homelab_shell_procs and
        proc.pname exists and
        proc.pname != "sh" and
        proc.pname != "bash" and
        proc.aname[2] != "docker"
      output: >
        Shell spawned in production container
        (container=%container.name
         namespace=%k8s.ns.name
         pod=%k8s.pod.name
         shell=%proc.name
         parent=%proc.pname
         cmdline=%proc.cmdline
         user=%user.name
         uid=%user.uid
         image=%container.image.repository)
      priority: WARNING
      tags:
        - container
        - shell
        - mitre_execution
        - runtime_security

    ##############################################################################
    ## Rule 2: Sensitive File Read
    ##############################################################################
    - rule: Sensitive File Read in Container
      desc: >
        A process inside a container attempted to read a sensitive system file
        (e.g., /etc/shadow, SSH keys, Kubernetes config). This is highly
        suspicious in containerized environments and may indicate credential
        theft or privilege escalation.
      condition: >
        open_read and
        container and
        homelab_monitored_namespace and
        homelab_sensitive_file_read and
        not proc.name in (trusted_system_binaries)
      output: >
        Sensitive file read detected in container
        (file=%fd.name
         container=%container.name
         namespace=%k8s.ns.name
         pod=%k8s.pod.name
         process=%proc.name
         cmdline=%proc.cmdline
         user=%user.name
         uid=%user.uid
         parent=%proc.pname
         image=%container.image.repository)
      priority: ERROR
      tags:
        - container
        - credential_access
        - mitre_credential_access
        - runtime_security
        - sensitive_file

    ##############################################################################
    ## Rule 3: Container Drift Detection
    ##############################################################################
    - rule: Binary Written to Container Filesystem
      desc: >
        A binary was written to a container's filesystem after it started.
        Containers should be immutable. This may indicate malware installation,
        cryptocurrency mining, or a misconfigured CI/CD pipeline.
      condition: >
        open_write and
        container and
        homelab_monitored_namespace and
        (fd.name startswith "/bin/" or
         fd.name startswith "/usr/bin/" or
         fd.name startswith "/usr/local/bin/" or
         fd.name startswith "/sbin/" or
         fd.name startswith "/usr/sbin/")
      output: >
        Binary written to container filesystem
        (file=%fd.name
         container=%container.name
         namespace=%k8s.ns.name
         pod=%k8s.pod.name
         process=%proc.name
         cmdline=%proc.cmdline
         user=%user.name
         parent=%proc.pname
         image=%container.image.repository)
      priority: WARNING
      tags:
        - container
        - drift
        - mitre_persistence
        - runtime_security

    ##############################################################################
    ## Rule 4: Unexpected Network Connection
    ##############################################################################
    - list: suspicious_outbound_ports
      items: [6667, 3333, 8333, 9001, 9030]

    - rule: Unexpected Network Connection from Container
      desc: >
        A container established an outbound network connection to a suspicious port.
        This may indicate command-and-control traffic, cryptocurrency mining,
        or data exfiltration.
      condition: >
        outbound and
        container and
        homelab_monitored_namespace and
        fd.sport in (suspicious_outbound_ports)
      output: >
        Suspicious outbound connection from container
        (port=%fd.sport
         dest_ip=%fd.rip
         dest_port=%fd.rport
         container=%container.name
         namespace=%k8s.ns.name
         pod=%k8s.pod.name
         process=%proc.name
         cmdline=%proc.cmdline
         user=%user.name
         image=%container.image.repository)
      priority: WARNING
      tags:
        - container
        - network
        - mitre_command_and_control
        - runtime_security

## Falcosidekick integration
## Falcosidekick is deployed separately (task #34) and receives events from Falco
## via gRPC, then routes them to multiple destinations (Platform API webhook, Slack, etc.)
falcosidekick:
  ## Falcosidekick is installed separately (not as a subchart)
  ## This keeps the installation modular: Falco (wave 8), Falcosidekick (wave 9)
  enabled: false

## RBAC — Falco needs cluster-wide read access to pods/namespaces for enrichment
rbac:
  create: true

## Service Monitor for Prometheus (kube-prometheus-stack)
## Falco exposes metrics on /metrics (events processed, drops, rule matches, etc.)
serviceMonitor:
  enabled: false  # Set to true after kube-prometheus-stack is fully deployed
  labels:
    release: prometheus
  interval: 30s
  scrapeTimeout: 10s

## Node affinity/tolerations — not needed for homelab single node pool
nodeSelector: {}
affinity: {}
