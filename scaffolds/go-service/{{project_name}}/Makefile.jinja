# Makefile for {{ project_name }}
# Generated by homelab-platform go-service scaffold

.PHONY: help build test lint fmt docker-build docker-push clean

# Variables
BINARY_NAME={{ project_name }}
DOCKER_IMAGE={{ acr_name }}.azurecr.io/{{ project_name }}
VERSION?=dev
GIT_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_DATE=$(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS=-ldflags "-s -w -X main.Version=$(VERSION) -X main.GitCommit=$(GIT_COMMIT) -X main.BuildDate=$(BUILD_DATE)"

## help: Show this help message
help:
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@grep -E '^## ' Makefile | sed 's/^## /  /'

## build: Build the binary
build:
	@echo "Building $(BINARY_NAME)..."
	CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build $(LDFLAGS) -o bin/$(BINARY_NAME) .
	@echo "Binary built: bin/$(BINARY_NAME)"

## test: Run unit tests
test:
	@echo "Running tests..."
	go test -v -race -coverprofile=coverage.out ./...
	@echo "Coverage:"
	go tool cover -func=coverage.out | grep total

## test-coverage: Generate HTML test coverage report
test-coverage: test
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report: coverage.html"

## lint: Run golangci-lint
lint:
	@echo "Running linters..."
	golangci-lint run --timeout 5m

## fmt: Format Go code
fmt:
	@echo "Formatting code..."
	gofmt -w -s .
	goimports -w .

## vet: Run go vet
vet:
	@echo "Running go vet..."
	go vet ./...

## mod-tidy: Tidy Go modules
mod-tidy:
	@echo "Tidying Go modules..."
	go mod tidy

## docker-build: Build Docker image
docker-build:
	@echo "Building Docker image $(DOCKER_IMAGE):$(VERSION)..."
	docker build -t $(DOCKER_IMAGE):$(VERSION) -t $(DOCKER_IMAGE):latest .
	@echo "Docker image built: $(DOCKER_IMAGE):$(VERSION)"

## docker-push: Push Docker image to ACR
docker-push:
	@echo "Pushing Docker image $(DOCKER_IMAGE):$(VERSION)..."
	docker push $(DOCKER_IMAGE):$(VERSION)
	docker push $(DOCKER_IMAGE):latest
	@echo "Docker image pushed"

## docker-run: Run Docker container locally
docker-run:
	@echo "Running Docker container..."
	docker run --rm -p {{ http_port }}:{{ http_port }} \
{%- if include_grpc %}
		-p {{ grpc_port }}:{{ grpc_port }} \
{%- endif %}
		-e LOG_LEVEL=debug \
		$(DOCKER_IMAGE):latest

## clean: Remove build artifacts
clean:
	@echo "Cleaning build artifacts..."
	rm -rf bin/ coverage.out coverage.html
	@echo "Clean complete"

## install-tools: Install development tools
install-tools:
	@echo "Installing development tools..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install golang.org/x/tools/cmd/goimports@latest
{%- if include_grpc %}
	go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
{%- endif %}
	@echo "Tools installed"

## run: Run the application locally
run:
	@echo "Running $(BINARY_NAME) locally..."
	go run .

## ci: Run CI pipeline locally (fmt, lint, test, build)
ci: fmt lint vet test build
	@echo "CI pipeline complete"

# Default target
.DEFAULT_GOAL := help
